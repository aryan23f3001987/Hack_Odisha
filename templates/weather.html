<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CropWise Weather - Agricultural Weather Insights</title>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA6Szch7lVEcfwHDU5e1Hi36MaRxN_-5vY",
            authDomain: "cultivio-e9741.firebaseapp.com",
            projectId: "cultivio-e9741",
            storageBucket: "cultivio-e9741.appspot.com",
            messagingSenderId: "885328104567",
            appId: "1:885328104567:web:0ce74325dbf11e8a4c8a72",
            measurementId: "G-XPCBK8L7QD"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.onAuthStateChanged(user => {
            if (!user) window.location.href = "/login";
        });
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-dark: #1a2332; --secondary-dark: #2d3748; --accent-green: #48bb78; --text-light: #e2e8f0;
            --text-muted: #a0aec0; --border-color: #4a5568; --hover-bg: #3a4553; --card-bg: #2a3441;
            --gradient-blue: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-orange: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            --gradient-rain: linear-gradient(135deg, #6b92b9 0%, #305375 100%);
            --gradient-storm: linear-gradient(135deg, #536976 0%, #292E49 100%);
        }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, var(--primary-dark) 0%, var(--secondary-dark) 100%); color: var(--text-light); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: rgba(26, 35, 50, 0.95); backdrop-filter: blur(10px); border-bottom: 2px solid var(--accent-green); position: sticky; top: 0; z-index: 100; }
        .header-content { display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .logo i { font-size: 2rem; color: var(--accent-green); }
        .logo h1 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(45deg, var(--accent-green), #8b6914); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-links { display: flex; gap: 2rem; list-style: none; }
        .nav-links a { color: var(--text-light); text-decoration: none; padding: 0.5rem 1rem; border-radius: 6px; transition: all 0.3s ease; font-weight: 500; }
        .nav-links a:hover, .nav-links a.active { background: var(--hover-bg); color: var(--accent-green); }
        .weather-hero { text-align: center; padding: 3rem 0; }
        .weather-hero h2 { font-size: 2.5rem; margin-bottom: 1rem; background: linear-gradient(45deg, #63b3ed, var(--accent-green)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .weather-hero p { font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem; }
        .search-container { background: var(--secondary-dark); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid var(--border-color); }
        .search-form { display: flex; gap: 1rem; align-items: center; max-width: 600px; margin: 0 auto; }
        .city-input { flex: 1; background: var(--primary-dark); border: 2px solid var(--border-color); border-radius: 12px; padding: 1rem 1.5rem; color: var(--text-light); font-size: 1rem; transition: border-color 0.3s ease; }
        .city-input:focus { outline: none; border-color: var(--accent-green); }
        .search-btn { background: linear-gradient(135deg, var(--accent-green), #38a169); border: none; border-radius: 12px; padding: 1rem 2rem; color: white; cursor: pointer; transition: all 0.3s ease; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
        .search-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(72,187,120,0.3); }
        .search-btn:disabled { background: var(--border-color); cursor: not-allowed; transform: none; }
        .weather-display { display: none; animation: fadeIn 0.5s ease-in-out; }
        .weather-display.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .weather-main { border-radius: 20px; padding: 3rem; text-align: center; margin-bottom: 2rem; box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
        .city-name { font-size: 2.5rem; font-weight: 700; color: white; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        .weather-date { font-size: 1.1rem; color: rgba(255,255,255,0.8); margin-bottom: 2rem; }
        .temperature-display { display: flex; align-items: center; justify-content: center; gap: 2rem; margin-bottom: 1.5rem; }
        .temperature { font-size: 5rem; font-weight: 300; color: white; text-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        .weather-icon i { font-size: 4rem; color: white; opacity: 0.9; }
        .weather-description { font-size: 1.3rem; color: rgba(255,255,255,0.9); text-transform: capitalize; }
        .weather-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; }
        .detail-card { background: var(--card-bg); border-radius: 16px; padding: 1.5rem; text-align: center; border: 1px solid var(--border-color); transition: transform 0.3s ease; }
        .detail-card:hover { transform: translateY(-5px); }
        .detail-icon { font-size: 2rem; margin-bottom: 1rem; color: var(--accent-green); }
        .detail-card h4 { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 0.5rem; font-weight: 500; text-transform: uppercase; }
        .detail-value { font-size: 1.5rem; font-weight: 600; }
        .forecast-container { margin-top: 2.5rem; }
        .forecast-container h3 { color: var(--accent-green); font-size: 1.5rem; margin-bottom: 1.5rem; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .forecast-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; }
        .forecast-card { background: var(--card-bg); border-radius: 12px; padding: 1rem; border: 1px solid var(--border-color); transition: all 0.3s ease; display: flex; flex-direction: column; text-align: center; }
        .forecast-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.3); border-color: var(--accent-green); }
        .forecast-day { font-weight: 600; font-size: 1.1rem; margin-bottom: 1rem; }
        .forecast-card .weather-icon i { font-size: 2.5rem; color: #63b3ed; margin-bottom: 1rem; }
        .forecast-temp { font-size: 1.3rem; font-weight: 600; }
        .forecast-temp span { color: var(--text-muted); }
        .forecast-details { border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: auto; font-size: 0.85rem; display: grid; gap: 0.5rem; }
        .forecast-details div { display: flex; justify-content: space-between; align-items: center; }
        .forecast-details i { color: var(--text-muted); margin-right: 0.5rem; }
        .error-message { background: linear-gradient(135deg, #e53e3e, #c53030); color: white; padding: 1.5rem; border-radius: 12px; text-align: center; margin-top: 1rem; font-weight: 500; }
        .loading { display: none; text-align: center; padding: 2rem; }
        .loading-spinner { display: inline-block; width: 40px; height: 40px; border: 4px solid var(--border-color); border-radius: 50%; border-top-color: var(--accent-green); animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .back-to-chat { position: fixed; bottom: 2rem; right: 2rem; background: linear-gradient(135deg, var(--accent-green), #38a169); color: white; border: none; border-radius: 50px; padding: 1rem 2rem; cursor: pointer; transition: all 0.3s ease; font-weight: 600; z-index: 1000; }
        .back-to-chat:hover { transform: translateY(-3px); }
        @media (max-width: 992px) { .forecast-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .weather-details { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); } .header-content { flex-direction: column; } }
        .sunny { background: var(--gradient-orange); } .cloudy { background: var(--gradient-blue); } .rainy { background: var(--gradient-rain); } .stormy { background: var(--gradient-storm); }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-seedling"></i>
                <h1>CropWise</h1>
            </div>
            <nav>
                <ul class="nav-links">
                    <li><a href="/chat"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="/chat"><i class="fas fa-comments"></i> Chat</a></li>
                    <li><a href="/weather" class="active"><i class="fas fa-cloud-sun-rain"></i> Weather</a></li>
                    <li><a href="/crop_cards"><i class="fas fa-leaf"></i> Crops</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <section class="weather-hero">
            <h2><i class="fas fa-cloud-sun-rain"></i> Agricultural Weather Insights</h2>
            <p>Get real-time weather data and a 5-day forecast for better crop management</p>
        </section>
        <div class="search-container">
            <form class="search-form" id="weatherForm">
                <input type="text" class="city-input" id="cityInput" placeholder="Enter city name..." required />
                <button type="submit" class="search-btn" id="searchBtn"><i class="fas fa-search"></i> Get Weather</button>
            </form>
        </div>
        <div class="loading" id="loading"><div class="loading-spinner"></div><p style="margin-top: 1rem;">Fetching weather data...</p></div>
        <div class="weather-display" id="weatherDisplay"></div>
    </div>
    <button class="back-to-chat" onclick="window.location.href='/chat'"><i class="fas fa-arrow-left"></i> Back to Chat</button>

    <script>
        const weatherForm = document.getElementById('weatherForm');
        const cityInput = document.getElementById('cityInput');
        const searchBtn = document.getElementById('searchBtn');
        const loading = document.getElementById('loading');
        const weatherDisplay = document.getElementById('weatherDisplay');

        const weatherIcons = {'clear sky':'fas fa-sun','few clouds':'fas fa-cloud-sun','scattered clouds':'fas fa-cloud','broken clouds':'fas fa-cloud','overcast clouds':'fas fa-cloud','shower rain':'fas fa-cloud-showers-heavy','rain':'fas fa-cloud-rain','light rain':'fas fa-cloud-rain','moderate rain':'fas fa-cloud-showers-heavy','thunderstorm':'fas fa-bolt','snow':'fas fa-snowflake','mist':'fas fa-smog','fog':'fas fa-smog','haze':'fas fa-smog','smoke':'fas fa-smog','dust':'fas fa-smog'};
        
        function getWeatherIcon(desc) { return weatherIcons[desc.toLowerCase()] || 'fas fa-cloud'; }
        
        function getWeatherConditionClass(desc) {
            const d = desc.toLowerCase();
            if (d.includes('clear') || d.includes('sun')) return 'sunny';
            if (d.includes('rain') || d.includes('shower')) return 'rainy';
            if (d.includes('storm')) return 'stormy';
            return 'cloudy';
        }

        function getWindDirection(deg) {
            const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            return dirs[Math.round((deg % 360) / 22.5) % 16];
        }

        async function fetchWeather(city) {
            loading.style.display = 'block';
            weatherDisplay.classList.remove('show');
            searchBtn.disabled = true;
            cityInput.disabled = true;
            try {
                const formData = new FormData();
                formData.append('city', city);
                const response = await fetch('/get_weather', { method: 'POST', body: formData });
                const data = await response.json();
                if (response.ok) {
                    displayWeather(data);
                } else {
                    showError(data.error || 'Failed to fetch weather data');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Network error. Please check your connection.');
            } finally {
                loading.style.display = 'none';
                searchBtn.disabled = false;
                cityInput.disabled = false;
            }
        }

        weatherForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const city = cityInput.value.trim();
            if (city) fetchWeather(city);
        });

        function displayWeather(data) {
            const { current, forecast } = data;
            const weatherHTML = `
                <div class="weather-main ${getWeatherConditionClass(current.description)}">
                    <div class="city-name">${current.city}</div>
                    <div class="weather-date">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                    <div class="temperature-display">
                        <div class="temperature">${Math.round(current.temperature)}째C</div>
                        <div class="weather-icon"><i class="${getWeatherIcon(current.description)}"></i></div>
                    </div>
                    <div class="weather-description">${current.description}</div>
                </div>

                <div class="weather-details">
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-tint"></i></div>
                        <h4>Humidity</h4>
                        <div class="detail-value">${current.humidity}%</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-wind"></i></div>
                        <h4>Wind</h4>
                        <div class="detail-value">${current.wind_speed.toFixed(1)} m/s ${getWindDirection(current.wind_deg)}</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-thermometer-half"></i></div>
                        <h4>Feels Like</h4>
                        <div class="detail-value">${Math.round(current.feels_like)}째C</div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-eye"></i></div>
                        <h4>Visibility</h4>
                        <div class="detail-value">${(current.visibility / 1000).toFixed(1)} km</div>
                    </div>
                </div>

                <div class="forecast-container">
                    <h3><i class="fas fa-calendar-alt"></i> 5-Day Forecast</h3>
                    <div class="forecast-grid">
                        ${forecast.map(day => `
                            <div class="forecast-card">
                                <div class="forecast-day">${day.day}</div>
                                <div class="weather-icon"><i class="${getWeatherIcon(day.description)}"></i></div>
                                <div class="forecast-temp">${Math.round(day.max_temp)}째<span> / ${Math.round(day.min_temp)}째</span></div>
                                <div class="forecast-details">
                                    <div>
                                        <span><i class="fas fa-cloud-rain"></i> Rain</span>
                                        <strong>${day.rain.toFixed(1)} mm</strong>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            weatherDisplay.innerHTML = weatherHTML;
            weatherDisplay.classList.add('show');
        }

        function showError(message) {
            weatherDisplay.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
            weatherDisplay.classList.add('show');
        }

        document.addEventListener('DOMContentLoaded', () => {
            cityInput.focus();
            fetchWeather('Purnia');
        });
    </script>
</body>
</html>